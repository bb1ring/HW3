---
title: "p8105_hw3_SL5454"
output: github_document
date: "2024-10-10"
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
library(tidyverse)
library(ggridges)
library(tidyr)
library(patchwork)
library(readxl)
```


## Problem 1
```{r}
library(p8105.datasets)
data("ny_noaa")
```

Dataset description:
This dataset shows some of the weather data in New York, including the date of collection, maximum and minimum temperature, total daily precipitation, snowfall, and snow depth.
The structure of the dataset includes rows for each date of collection, with columns for each of the weather measurements. The dataset spans the period from January 1981 through December 2010 and contains approximately 2.6 million records. 
When attempting to predict trends in these measurements, missing values in precipitation, snowfall, and snow depth may affect the results of the analysis.

```{r}
summary(ny_noaa)

ny_weather = ny_noaa |>
  janitor::clean_names() |>
  separate(date, into = c("year", "month", "day"), sep = "-") |>
  mutate(
    year = as.numeric(year),
    month = as.numeric(month),
    day = as.numeric(day),
    tmax = as.numeric(tmax),
    tmin = as.numeric(tmin),
    tmin_celsius = tmin / 10,
    tmax_celsius = tmax / 10,
    prcp_mm = prcp / 10)

ny_weather |>
  count(snow) |>
  arrange(desc(n)) |>
  head(n = 3)
```
The most common observed value is 0, because many days likely have no snowfall.

The two-panel plot showing the average max temperature in January and in July in each station across years.
```{r}
ny_weather |>
  filter(month == c("1", "7")) |>
  group_by(id, year, month) |>
  summarise(avg_tmax = mean(tmax_celsius, na.rm = TRUE)) |>
  ungroup() |>
  ggplot(aes(x = year, y = avg_tmax)) +
  geom_point() +
  facet_wrap(~ month) +
  labs(title = "Average Max Temperature in January and July",
       x = "Month", y = "Average Max Temperature (C)") 
```
In Janurary 2004, there were 2 outliers, showing an unusual high maximum temperature. In July 1988, there were 1 outlier, showing an usual low maximum temperature.
The average maximum temperature in July didn't change much across the year. On the contrary, the maximum temperature in Janurary went up and down across years.

(i) tmax vs tmin for the full dataset
```{r}
ny_weather |>
  filter(!is.na(tmin) & !is.na(tmax)) |>
  ggplot(aes(x = tmin, y = tmax)) +
  geom_hex() +
  labs(title = "Max Temperature vs Min Temperature",
    x = "Min Temperature (C)", y = "Max Temperature (C)") +
  theme_minimal()
```
(ii) The distribution of snowfall values greater than 0 and less than 100 separately by year
```{r}
ny_weather|>
  filter(snow > '0' & snow < '100') |>
  ggplot(aes(x = year, y = snow)) + 
  geom_violin(alpha = 0.3) +
  labs(title = "Distribution of Snowfall Values (0, 100) by Year",
       y = "Snowfall", x = "Years") 
```

## Problem 2
```{r}
accelv = read_csv(file = "./data/nhanes_accel.csv",
                  na = c("NA", "", ".")) |>
  janitor::clean_names()

demo = read_csv(
  file = "./data/nhanes_covar.csv",
  na = c("NA", "", "."), 
  skip = 4) |>
  janitor::clean_names() |>
  filter(age >= '21' & !is.na(education) & !is.na(bmi))

all_data = 
  left_join(demo, accelv, by = "seqn") |>
  mutate(sex = factor(sex, levels = c(1, 2), labels = c("Male", "Female")),
         education = factor(education, levels = 1:3, labels = c("Less than High School", 
                                                                "High School Equivalent", 
                                                                "More than High School"))) 
```

The table for sex distribution in each education category, and the graph for age distribution in each education category.

```{r}
all_data |>
  group_by(sex, education) |>
  summarize(count = n()) |>
  ungroup() |>
  pivot_wider(
    names_from = 'sex',
    values_from = 'count'
  ) |>
  knitr::kable()

all_data|>
  ggplot(aes(x = sex, y = age)) +
  geom_boxplot() +
  facet_wrap(~education) +
  labs(
    title =  "Age Distribution for Men and Women in Education",
    x = "Sex",
    y = "Age"
  )
```
Almost half of the women and men received education more than high school. Those people usually has a smaller median age comparing to other groups. There are more men than women in the group with high school equivalent education. In addition, in this group, men tend to be educated at a younger age than women.

Graph: Total activity vs age by sex and education level 
```{r}
data_clean = all_data |>
  pivot_longer(
    cols = min1:min1440,
    names_to = "min",
    names_prefix = "min", 
    values_to = "activity"
  ) |>
  mutate(min = as.numeric(min))

data_clean |>
  group_by(seqn, age, sex, education) |>
  summarise(total_activity = sum(activity, na.rm = TRUE)) |>
  ungroup() |>
  ggplot(aes(x = age, y = total_activity, color = sex)) +
  geom_point() +                 
  geom_smooth() + 
  facet_wrap(~ education) +                  
  labs(title = "Total Activity and Age Trend by Sex and Education Level",
       x = "Age",
       y = "Total Activity") +
  theme_minimal()
```
In general, the total value of activity is greater for women than for men at all ages with high school equivalent and more than high school education. In less than high school education group, men have more total activity than women after ago of 40.

```{r}
data_clean |>
  mutate(hour = min / 60) |>
  group_by(sex, education, hour) |>
  summarize(mean_activity = mean(activity, na.rm = TRUE)) |>
  ggplot(aes(x = hour, y = mean_activity, color = sex)) +
  geom_point(alpha = 0.3) +
  geom_smooth() +
  facet_wrap(~ education, nrow = 3) +
  labs(title = "24-Hour Activity Time Course by Education and Sex",
       x = "Time of Day (hours)", y = "Mean Activity") 
```
Most people's activity levels increase dramatically from 5am to 10am. Across all levels of education, women are typically more active than men in the middle of the day.

## Problem 3
```{r}
Jan2020 = read_csv(file = "./data/citibike/Jan 2020 Citi.csv",
                  na = c("NA", "", ".")) |>
  janitor::clean_names() |>
  mutate(year = "2020", month = "Janurary")

July2020 = read_csv(file = "./data/citibike/July 2020 Citi.csv",
                  na = c("NA", "", ".")) |>
  janitor::clean_names() |>
  mutate(year = "2020", month = "July")

Jan2024 = read_csv(file = "./data/citibike/Jan 2024 Citi.csv",
                  na = c("NA", "", ".")) |>
  janitor::clean_names() |>
  mutate(year = "2024", month = "Janurary")
  
July2024 = read_csv(file = "./data/citibike/July 2024 Citi.csv",
                  na = c("NA", "", ".")) |>
  janitor::clean_names() |>
  mutate(year = "2024", month = "July")

citibike = bind_rows(Jan2020, July2020, Jan2024, July2024)
```

Produce a reader-friendly table showing the total number of rides in each combination of year and month separating casual riders and Citi Bike members. Comment on these results.
```{r}
citibike |>
  group_by(year, month, member_casual) |>
  summarise(total_rides = n()) |>
  ungroup() |>
  pivot_wider(
    names_from = member_casual, 
    values_from = total_rides) |>
  knitr::kable()
```
Compared to 2020, the total number of people using the Citi bike in 2024 has doubled. In both 2020 and 2024, the number of people using Citi bikes in July is more than in January, and the number of member is larger than the number of casual. 

